(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.ChainsafeLibp2PYamux = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var ChainsafeLibp2PYamux=(()=>{var at=Object.create;var j=Object.defineProperty;var lt=Object.getOwnPropertyDescriptor;var ut=Object.getOwnPropertyNames;var ct=Object.getPrototypeOf,ht=Object.prototype.hasOwnProperty;var le=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),ft=(r,e)=>{for(var t in e)j(r,t,{get:e[t],enumerable:!0})},Ie=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ut(e))!ht.call(r,s)&&s!==t&&j(r,s,{get:()=>e[s],enumerable:!(n=lt(e,s))||n.enumerable});return r};var dt=(r,e,t)=>(t=r!=null?at(ct(r)):{},Ie(e||!r||!r.__esModule?j(t,"default",{value:r,enumerable:!0}):t,r)),mt=r=>Ie(j({},"__esModule",{value:!0}),r);var Le=le((Jt,De)=>{var P=1e3,V=P*60,G=V*60,M=G*24,pt=M*7,gt=M*365.25;De.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return wt(r);if(t==="number"&&isFinite(r))return e.long?yt(r):bt(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function wt(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*gt;case"weeks":case"week":case"w":return t*pt;case"days":case"day":case"d":return t*M;case"hours":case"hour":case"hrs":case"hr":case"h":return t*G;case"minutes":case"minute":case"mins":case"min":case"m":return t*V;case"seconds":case"second":case"secs":case"sec":case"s":return t*P;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function bt(r){var e=Math.abs(r);return e>=M?Math.round(r/M)+"d":e>=G?Math.round(r/G)+"h":e>=V?Math.round(r/V)+"m":e>=P?Math.round(r/P)+"s":r+"ms"}function yt(r){var e=Math.abs(r);return e>=M?J(r,e,M,"day"):e>=G?J(r,e,G,"hour"):e>=V?J(r,e,V,"minute"):e>=P?J(r,e,P,"second"):r+" ms"}function J(r,e,t,n){var s=e>=t*1.5;return Math.round(r/t)+" "+n+(s?"s":"")}});var Ne=le((Qt,Fe)=>{function Et(r){t.debug=t,t.default=t,t.coerce=m,t.disable=i,t.enable=s,t.enabled=l,t.humanize=Le(),t.destroy=S,Object.keys(r).forEach(a=>{t[a]=r[a]}),t.names=[],t.skips=[],t.formatters={};function e(a){let o=0;for(let h=0;h<a.length;h++)o=(o<<5)-o+a.charCodeAt(h),o|=0;return t.colors[Math.abs(o)%t.colors.length]}t.selectColor=e;function t(a){let o,h=null,x,p;function d(...c){if(!d.enabled)return;let g=d,y=Number(new Date),E=y-(o||y);g.diff=E,g.prev=o,g.curr=y,o=y,c[0]=t.coerce(c[0]),typeof c[0]!="string"&&c.unshift("%O");let C=0;c[0]=c[0].replace(/%([a-zA-Z%])/g,(L,v)=>{if(L==="%%")return"%";C++;let F=t.formatters[v];if(typeof F=="function"){let W=c[C];L=F.call(g,W),c.splice(C,1),C--}return L}),t.formatArgs.call(g,c),(g.log||t.log).apply(g,c)}return d.namespace=a,d.useColors=t.useColors(),d.color=t.selectColor(a),d.extend=n,d.destroy=t.destroy,Object.defineProperty(d,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(x!==t.namespaces&&(x=t.namespaces,p=t.enabled(a)),p),set:c=>{h=c}}),typeof t.init=="function"&&t.init(d),d}function n(a,o){let h=t(this.namespace+(typeof o>"u"?":":o)+a);return h.log=this.log,h}function s(a){t.save(a),t.namespaces=a,t.names=[],t.skips=[];let o,h=(typeof a=="string"?a:"").split(/[\s,]+/),x=h.length;for(o=0;o<x;o++)h[o]&&(a=h[o].replace(/\*/g,".*?"),a[0]==="-"?t.skips.push(new RegExp("^"+a.slice(1)+"$")):t.names.push(new RegExp("^"+a+"$")))}function i(){let a=[...t.names.map(u),...t.skips.map(u).map(o=>"-"+o)].join(",");return t.enable(""),a}function l(a){if(a[a.length-1]==="*")return!0;let o,h;for(o=0,h=t.skips.length;o<h;o++)if(t.skips[o].test(a))return!1;for(o=0,h=t.names.length;o<h;o++)if(t.names[o].test(a))return!0;return!1}function u(a){return a.toString().substring(2,a.toString().length-2).replace(/\.\*\?$/,"*")}function m(a){return a instanceof Error?a.stack||a.message:a}function S(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}Fe.exports=Et});var Ue=le((_,Q)=>{_.formatArgs=Ct;_.save=Rt;_.load=xt;_.useColors=St;_.storage=At();_.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();_.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function St(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Ct(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+Q.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}_.log=console.debug||console.log||(()=>{});function Rt(r){try{r?_.storage.setItem("debug",r):_.storage.removeItem("debug")}catch{}}function xt(){let r;try{r=_.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function At(){try{return localStorage}catch{}}Q.exports=Ne()(_);var{formatters:vt}=Q.exports;vt.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var $t={};ft($t,{GoAwayCode:()=>D,yamux:()=>qt});var f=class extends Error{code;props;constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}};var I=dt(Ue(),1);function _t(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),l=i.charCodeAt(0);if(t[l]!==255)throw new TypeError(i+" is ambiguous");t[l]=s}var u=r.length,m=r.charAt(0),S=Math.log(u)/Math.log(256),a=Math.log(256)/Math.log(u);function o(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var d=0,c=0,g=0,y=p.length;g!==y&&p[g]===0;)g++,d++;for(var E=(y-g)*a+1>>>0,C=new Uint8Array(E);g!==y;){for(var A=p[g],L=0,v=E-1;(A!==0||L<c)&&v!==-1;v--,L++)A+=256*C[v]>>>0,C[v]=A%u>>>0,A=A/u>>>0;if(A!==0)throw new Error("Non-zero carry");c=L,g++}for(var F=E-c;F!==E&&C[F]===0;)F++;for(var W=m.repeat(d);F<E;++F)W+=r.charAt(C[F]);return W}function h(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var d=0;if(p[d]!==" "){for(var c=0,g=0;p[d]===m;)c++,d++;for(var y=(p.length-d)*S+1>>>0,E=new Uint8Array(y);p[d];){var C=t[p.charCodeAt(d)];if(C===255)return;for(var A=0,L=y-1;(C!==0||A<g)&&L!==-1;L--,A++)C+=u*E[L]>>>0,E[L]=C%256>>>0,C=C/256>>>0;if(C!==0)throw new Error("Non-zero carry");g=A,d++}if(p[d]!==" "){for(var v=y-g;v!==y&&E[v]===0;)v++;for(var F=new Uint8Array(c+(y-v)),W=c;v!==y;)F[W++]=E[v++];return F}}}function x(p){var d=h(p);if(d)return d;throw new Error(`Non-${e} character`)}return{encode:o,decodeUnsafe:h,decode:x}}var It=_t,Dt=It,Te=Dt;var er=new Uint8Array(0);var Oe=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var ue=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},ce=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return ke(this,e)}},he=class{constructor(e){this.decoders=e}or(e){return ke(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},ke=(r,e)=>new he({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}}),fe=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new ue(e,t,n),this.decoder=new ce(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},Me=({name:r,prefix:e,encode:t,decode:n})=>new fe(r,e,t,n),de=({prefix:r,name:e,alphabet:t})=>{let{encode:n,decode:s}=Te(t,e);return Me({prefix:r,name:e,encode:n,decode:i=>Oe(s(i))})},Lt=(r,e,t,n)=>{let s={};for(let a=0;a<e.length;++a)s[e[a]]=a;let i=r.length;for(;r[i-1]==="=";)--i;let l=new Uint8Array(i*t/8|0),u=0,m=0,S=0;for(let a=0;a<i;++a){let o=s[r[a]];if(o===void 0)throw new SyntaxError(`Non-${n} character`);m=m<<t|o,u+=t,u>=8&&(u-=8,l[S++]=255&m>>u)}if(u>=t||255&m<<8-u)throw new SyntaxError("Unexpected end of data");return l},Ft=(r,e,t)=>{let n=e[e.length-1]==="=",s=(1<<t)-1,i="",l=0,u=0;for(let m=0;m<r.length;++m)for(u=u<<8|r[m],l+=8;l>t;)l-=t,i+=e[s&u>>l];if(l&&(i+=e[s&u<<t-l]),n)for(;i.length*t&7;)i+="=";return i},R=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Me({prefix:e,name:r,encode(s){return Ft(s,n,t)},decode(s){return Lt(s,n,t,r)}});var We=R({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),or=R({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),ar=R({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),lr=R({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ur=R({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),cr=R({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),hr=R({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),fr=R({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),dr=R({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Pe=de({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),gr=de({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Ve=R({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),yr=R({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Er=R({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Sr=R({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});I.default.formatters.b=r=>r==null?"undefined":Pe.baseEncode(r);I.default.formatters.t=r=>r==null?"undefined":We.baseEncode(r);I.default.formatters.m=r=>r==null?"undefined":Ve.baseEncode(r);I.default.formatters.p=r=>r==null?"undefined":r.toString();I.default.formatters.c=r=>r==null?"undefined":r.toString();I.default.formatters.k=r=>r==null?"undefined":r.toString();I.default.formatters.a=r=>r==null?"undefined":r.toString();function Nt(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Z(r){let e=Nt(`${r}:trace`);return I.default.enabled(`${r}:trace`)&&I.default.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=(0,I.default)(`${r}:trace`)),Object.assign((0,I.default)(r),{error:(0,I.default)(`${r}:error`),trace:e})}var Y=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Ge(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function ee(r,e,t){let n=t??{},s=Ge(r);async function*i(){let l,u=()=>{l?.()};for(e.addEventListener("abort",u);;){let m;try{if(e.aborted){let{abortMessage:a,abortCode:o}=n;throw new Y(a,o)}let S=new Promise((a,o)=>{l=()=>{let{abortMessage:h,abortCode:x}=n;o(new Y(h,x))}});m=await Promise.race([S,s.next()]),l=null}catch(S){e.removeEventListener("abort",u);let a=S.type==="aborted"&&e.aborted;if(a&&n.onAbort!=null&&n.onAbort(r),typeof s.return=="function")try{let o=s.return();o instanceof Promise&&o.catch(h=>{n.onReturnError!=null&&n.onReturnError(h)})}catch(o){n.onReturnError!=null&&n.onReturnError(o)}if(a&&n.returnOnAbort===!0)return;throw S}if(m.done===!0)break;yield m.value}e.removeEventListener("abort",u)}return i()}function B(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var te=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},z=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new te(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new te(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var me=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function T(r={}){return Ut(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function Ut(r,e){e=e??{};let t=e.onEnd,n=new z,s,i,l,u=B(),m=async()=>{try{return n.isEmpty()?l?{done:!0}:await new Promise((c,g)=>{i=y=>{i=null,n.push(y);try{c(r(n))}catch(E){g(E)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{u.resolve(),u=B()})}},S=c=>i!=null?i(c):(n.push(c),s),a=c=>(n=new z,i!=null?i({error:c}):(n.push({error:c}),s)),o=c=>{if(l)return s;if(e?.objectMode!==!0&&c?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return S({done:!1,value:c})},h=c=>l?s:(l=!0,c!=null?a(c):S({done:!0})),x=()=>(n=new z,h(),{done:!0}),p=c=>(h(c),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:m,return:x,throw:p,push:o,end:h,get readableLength(){return n.size},onEmpty:async c=>{let g=c?.signal;if(g?.throwIfAborted(),n.isEmpty())return;let y,E;g!=null&&(y=new Promise((C,A)=>{E=()=>{A(new me)},g.addEventListener("abort",E)}));try{await Promise.race([u.promise,y])}finally{E!=null&&g!=null&&g?.removeEventListener("abort",E)}}},t==null)return s;let d=s;return s={[Symbol.asyncIterator](){return this},next(){return d.next()},throw(c){return d.throw(c),t!=null&&(t(c),t=void 0),{done:!0}},return(){return d.return(),t!=null&&(t(),t=void 0),{done:!0}},push:o,end(c){return d.end(c),t!=null&&(t(c),t=void 0),s},get readableLength(){return d.readableLength}},s}function Tt(r){return r[Symbol.asyncIterator]!=null}function Ot(...r){let e=[];for(let t of r)Tt(t)||e.push(t);return e.length===r.length?function*(){for(let t of e)yield*t}():async function*(){let t=T({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(r.map(async n=>{for await(let s of n)t.push(s)})),t.end()}catch(n){t.end(n)}}),yield*t}()}var Be=Ot;function ze(r,...e){if(r==null)throw new Error("Empty pipeline");if(pe(r)){let n=r;r=()=>n.source}else if(He(r)||Xe(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&pe(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)pe(t[n])&&(t[n]=Mt(t[n]));return kt(...t)}var kt=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},Xe=r=>r?.[Symbol.asyncIterator]!=null,He=r=>r?.[Symbol.iterator]!=null,pe=r=>r==null?!1:r.sink!=null&&r.source!=null,Mt=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=T({objectMode:!0});t.then(()=>{n.end()},l=>{n.end(l)});let s,i=r.source;if(Xe(i))s=async function*(){yield*i,n.end()};else if(He(i))s=function*(){yield*i,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Be(n,s())}return r.source};var X="ERR_INVALID_FRAME",ge="ERR_UNREQUESTED_PING",we="ERR_NOT_MATCHING_PING",be="ERR_STREAM_ALREADY_EXISTS",ye="ERR_DECODE_INVALID_VERSION",Ee="ERR_BOTH_CLIENTS",Se="ERR_RECV_WINDOW_EXCEEDED",Ye=new Set([X,ge,we,be,ye,Ee,Se]),O="ERR_INVALID_CONFIG",re="ERR_MUXER_LOCAL_CLOSED",Ce="ERR_MUXER_REMOTE_CLOSED";var qe="ERR_STREAM_ABORT",$e="ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED",Ke="ERR_DECODE_IN_PROGRESS",q=256*1024,je=16*1024*1024;var Je={log:Z("libp2p:yamux"),enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:q,maxStreamWindowSize:je,maxMessageSize:64*1024};function Qe(r){if(r.keepAliveInterval<=0)throw new f("keep-alive interval must be positive",O);if(r.maxInboundStreams<0)throw new f("max inbound streams must be larger or equal 0",O);if(r.maxOutboundStreams<0)throw new f("max outbound streams must be larger or equal 0",O);if(r.initialStreamWindowSize<q)throw new f("InitialStreamWindowSize must be larger or equal 256 kB",O);if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new f("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",O);if(r.maxStreamWindowSize>2**32-1)throw new f("MaxStreamWindowSize must be less than equal MAX_UINT32",O);if(r.maxMessageSize<1024)throw new f("MaxMessageSize must be greater than a kilobyte",O)}function $(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}function U(r=0){return globalThis.Buffer?.alloc!=null?$(globalThis.Buffer.alloc(r)):new Uint8Array(r)}function K(r=0){return globalThis.Buffer?.allocUnsafe!=null?$(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function Re(r,e){e==null&&(e=r.reduce((s,i)=>s+i.length,0));let t=K(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return $(t)}function Ze(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var tt=Symbol.for("@achingbrain/uint8arraylist");function et(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function ne(r){return!!r?.[tt]}var H=class r{constructor(...e){Object.defineProperty(this,tt,{value:!0}),this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(ne(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(ne(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=et(this.bufs,e);return t.buf[t.index]}set(e,t){let n=et(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(ne(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:s}=this._subList(e,t);return Re(n,s)}subarray(e,t){let{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:Re(n,s)}sublist(e,t){let{bufs:n,length:s}=this._subList(e,t),i=new r;return i.length=s,i.bufs=n,i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:[...this.bufs],length:this.length};let n=[],s=0;for(let i=0;i<this.bufs.length;i++){let l=this.bufs[i],u=s,m=u+l.byteLength;if(s=m,e>=m)continue;let S=e>=u&&e<m,a=t>u&&t<=m;if(S&&a){if(e===u&&t===m){n.push(l);break}let o=e-u;n.push(l.subarray(o,o+(t-e)));break}if(S){if(e===0){n.push(l);continue}n.push(l.subarray(e-u));continue}if(a){if(t===m){n.push(l);break}n.push(l.subarray(0,t-u));break}n.push(l)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!ne(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");let i=256,l=new Int32Array(i);for(let o=0;o<i;o++)l[o]=-1;for(let o=0;o<s;o++)l[n[o]]=o;let u=l,m=this.byteLength-n.byteLength,S=n.byteLength-1,a;for(let o=t;o<=m;o+=a){a=0;for(let h=S;h>=0;h--){let x=this.get(o+h);if(n[h]!==x){a=Math.max(1,h-u[x]);break}}if(a===0)return o}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=K(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let s=U(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let s=U(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let s=U(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=K(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let s=U(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let s=U(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let s=U(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let s=U(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let s=U(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!Ze(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}};var b;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(b||(b={}));var w;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(w||(w={}));var Wt=Object.values(w).filter(r=>typeof r!="string"),rt=0,D;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(D||(D={}));var k=12;function xe(r){let e=Wt.filter(t=>(r.flag&t)===t).map(t=>w[t]).join("|");return`streamID=${r.streamID} type=${b[r.type]} flag=${e} length=${r.length}`}var nt=2**24;function Pt(r){if(r[0]!==rt)throw new f("Invalid frame version",ye);return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*nt+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*nt+(r[9]<<16)+(r[10]<<8)+r[11]}}var se=class{source;buffer;frameInProgress;constructor(e){this.source=Vt(e),this.buffer=new H,this.frameInProgress=!1}async*emitFrames(){for await(let e of this.source)for(this.buffer.append(e);;){let t=this.readHeader();if(t===void 0)break;let{type:n,length:s}=t;n===b.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,s)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new f("decoding frame already in progress",Ke);if(this.buffer.length<k)return;let e=Pt(this.buffer.subarray(0,k));return this.buffer.consume(k),e}async readBytes(e){if(this.buffer.length<e){for await(let n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}let t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function Vt(r){if(r[Symbol.iterator]!==void 0){let e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){let e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function Ae(r){let e=new Uint8Array(k);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}var Gt="ERR_STREAM_RESET",Bt="ERR_SINK_INVALID_STATE";function ve(r){return r!=null&&typeof r.then=="function"}var ie=class{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;sinkController;sinkEnd;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;log;constructor(e){this.sinkController=new AbortController,this.sinkEnd=B(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.onEnd=e.onEnd,this.onCloseRead=e?.onCloseRead,this.onCloseWrite=e?.onCloseWrite,this.onReset=e?.onReset,this.onAbort=e?.onAbort,this.source=this.streamSource=T({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.readStatus="closed",this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new f(`writable end state is "${this.writeStatus}" not "ready"`,Bt);try{this.writeStatus="writing";let t={signal:this.sinkController.signal};if(this.direction==="outbound"){let n=this.sendNewStream(t);ve(n)&&await n}e=ee(e,this.sinkController.signal,{returnOnAbort:!0}),this.log.trace("sink reading from source");for await(let n of e){n=n instanceof Uint8Array?new H(n):n;let s=this.sendData(n,t);ve(s)&&await s}this.log.trace("sink finished reading from source"),this.writeStatus="done",this.log.trace("sink calling closeWrite"),await this.closeWrite(t),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.onEnd!=null&&this.onEnd(this.endErr)):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.onEnd!=null&&this.onEnd(this.endErr)):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.log.trace("closing gracefully"),this.status="closing",await Promise.all([this.closeRead(e),this.closeWrite(e)]),this.status="closed",this.log.trace("closed gracefully")}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);let t=this.readStatus;this.readStatus="closing",t==="ready"&&(this.log.trace("ending internal source queue"),this.streamSource.end()),this.status!=="reset"&&this.status!=="aborted"&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),this.log.trace("closed readable end of stream")}async closeWrite(e={}){if(this.writeStatus==="closing"||this.writeStatus==="closed")return;this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus);let t=this.writeStatus;this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await this.sink([])),this.writeStatus="closing",t==="writing"&&await new Promise((n,s)=>{queueMicrotask(()=>{this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),this.sinkEnd.promise.then(n,s)})}),this.status!=="reset"&&this.status!=="aborted"&&(this.log.trace("send close write to remote"),await this.sendCloseWrite(e)),this.writeStatus="closed",this.log.trace("closed writable end of stream")}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");let t=this.sendReset();ve(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;let e=new f("stream reset",Gt);this.status="reset",this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("muxer destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}};function zt(r){let[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}var st=zt;function Xt(r){return r[Symbol.asyncIterator]!=null}function Ht(r,e){if(Xt(r))return async function*(){for await(let u of r)await e(u),yield u}();let t=st(r),{value:n,done:s}=t.next();if(s===!0)return function*(){}();if(typeof e(n)?.then=="function")return async function*(){yield n;for await(let u of t)await e(u),yield u}();let l=e;return function*(){yield n;for(let u of t)l(u),yield u}()}var it=Ht;var N;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(N||(N={}));var oe=class extends ie{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=N.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=q,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=it(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&await this.waitForSendWindowCapacity(t),this.status!=="open")return;let n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-k,e.length),s=this.getSendFlags();this.sendFrame({type:b.Data,flag:s,streamID:this._id,length:n},e.subarray(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:b.WindowUpdate,flag:w.RST,streamID:this._id,length:0})}async sendCloseWrite(){let e=this.getSendFlags()|w.FIN;this.sendFrame({type:b.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n,s=()=>{this.status==="open"?n(new f("stream aborted",qe)):t()};e.signal?.addEventListener("abort",s);try{await new Promise((i,l)=>{this.sendWindowCapacityUpdate=()=>{i()},n=l,t=i})}finally{e.signal?.removeEventListener("abort",s)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);let t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new f("receive window exceeded",Se,{available:this.recvWindowCapacity,recv:e.length});let n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&w.ACK)===w.ACK&&this.state===N.SYNSent&&(this.state=N.Established),(e&w.FIN)===w.FIN&&this.remoteCloseWrite(),(e&w.RST)===w.RST&&this.reset()}getSendFlags(){switch(this.state){case N.Init:return this.state=N.SYNSent,w.SYN;case N.SYNReceived:return this.state=N.Established,w.ACK;default:return 0}}sendWindowUpdate(){let e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>0&&t-this.epochStart<n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;let s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:b.WindowUpdate,flag:e,streamID:this._id,length:s})}};var ot="/yamux/1.0.0",Yt=500,ae=class{protocol=ot;_init;constructor(e={}){this._init=e}createStreamMuxer(e){return new _e({...this._init,...e})}},_e=class{protocol=ot;source;sink;config;log;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e){this.client=e.direction==="outbound",this.config={...Je,...e},this.log=this.config.log,Qe(this.config),this.closeController=new AbortController,this.onIncomingStream=e.onIncomingStream,this.onStreamEnd=e.onStreamEnd,this._streams=new Map,this.source=T({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(t=>{t.destroy()})}}),this.sink=async t=>{t=ee(t,this.closeController.signal,{returnOnAbort:!0});let n,s;try{let i=new se(t);await ze(i.emitFrames.bind(i),async l=>{for await(let{header:u,readData:m}of l)await this.handleFrame(u,m)}),n=D.NormalTermination}catch(i){let l=i.code;Ye.has(l)?(this.log?.error("protocol error in sink",i),n=D.ProtocolError):(this.log?.error("internal error in sink",i),n=D.InternalError),s=i}this.log?.trace("muxer sink ended"),s!=null?this.abort(s,n):await this.close({reason:n})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=0,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(t=>this.log?.error("keepalive error: %s",t))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new f("muxer closed remotely",Ce);if(this.localGoAway!==void 0)throw new f("muxer closed locally",re);let t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new f("max outbound streams exceeded",$e);this.log?.trace("new outgoing stream id=%s",t);let n=this._newStream(t,e,N.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new f("muxer closed remotely",Ce);if(this.localGoAway!==void 0)throw new f("muxer closed locally",re);if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,i)=>{let l=()=>{i(new f("muxer closed locally",re))};this.closeController.signal.addEventListener("abort",l,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",l),s()}}),resolve:e};let t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}let n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;let t=e?.reason??D.NormalTermination;this.log?.trace("muxer close reason=%s",t),e.signal=e.signal??AbortSignal.timeout(Yt);try{await Promise.all([...this._streams.values()].map(async n=>n.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(n){this.abort(n)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??D.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(let n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,s){if(this._streams.get(e)!=null)throw new f("Stream already exists",be,{id:e});let i=new oe({id:e.toString(),name:t,state:n,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(i)},log:Z(`libp2p:yamux:${s}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){let e=new Promise((t,n)=>{this.closeController.signal.addEventListener("abort",n,{once:!0})});for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await Promise.race([e,new Promise(n=>{t=setTimeout(n,this.config.keepAliveInterval)})]),this.ping().catch(n=>this.log?.error("ping error: %s",n))}catch{clearInterval(t);return}}}async handleFrame(e,t){let{streamID:n,type:s,length:i}=e;if(this.log?.trace("received frame %s",xe(e)),n===0)switch(s){case b.Ping:{this.handlePing(e);return}case b.GoAway:{this.handleGoAway(i);return}default:throw new f("Invalid frame type",X,{header:e})}else switch(e.type){case b.Data:case b.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new f("Invalid frame type",X,{header:e})}}handlePing(e){if(e.flag===w.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,w.ACK);else if(e.flag===w.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new f("Invalid frame flag",X,{header:e})}handlePingResponse(e){if(this.activePing===void 0)throw new f("ping not requested",ge);if(this.activePing.id!==e)throw new f("ping doesn't match our id",we);this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",D[e]??"unknown"),this.remoteGoAway=e;for(let t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){let{streamID:n,flag:s,type:i}=e;(s&w.SYN)===w.SYN&&this.incomingStream(n);let l=this._streams.get(n);if(l===void 0){if(i===b.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.("frame for missing stream id=%s",n);return}switch(i){case b.WindowUpdate:{l.handleWindowUpdate(e);return}case b.Data:{if(t===void 0)throw new Error("unreachable");await l.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new f("both endpoints are clients",Ee);if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:b.WindowUpdate,flag:w.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:b.WindowUpdate,flag:w.RST,streamID:e,length:0});return}let t=this._newStream(e,void 0,N.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %s",xe(e)),e.type===b.Data){if(t===void 0)throw new f("invalid frame",X);this.source.push(Ae(e)),this.source.push(t)}else this.source.push(Ae(e))}sendPing(e,t=w.SYN){t===w.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:b.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=D.NormalTermination){this.log?.("sending GoAway reason=%s",D[e]),this.localGoAway=e,this.sendFrame({type:b.GoAway,flag:0,streamID:0,length:e})}};function qt(r={}){return()=>new ae(r)}return mt($t);})();
return ChainsafeLibp2PYamux}));
