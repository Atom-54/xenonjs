var z=["log","warn","error","group","groupCollapsed","groupEnd"],S=["warn","error"],M=(e,t,s)=>{let n=`background: ${t||"gray"}; color: ${s||"white"}; padding: 1px 6px 2px 7px; border-radius: 6px 0 0 6px;`;return[`%c${e}`,n]},m=[],F=()=>{let e=globalThis.config?.logFlags||{},t=(r,i,o)=>{let a=M(r,i,o),p=c=>(...f)=>{let j=Date.now(),A=Error().stack.split(`
`).slice(1),d=A.shift();for(;d.includes("xen-async")||d.includes("xenon-atomic")||d.includes("logf");)d=A.shift();let I=d?.split?.("/").pop().split?.(")").shift();s(r,a,c,j,I,f,m),n(e,r,a,c,j,I,f)},l=p("log");return z.forEach(c=>l[c]=p(c)),l.flags=e,l.get=t.get,l.clear=t.clear,l.replay=t.replay,l},s=(r,i,o,a,p,l)=>{let c=Object.create(null);Object.assign(c,{preamble:r,format:i,kind:o,where:p,when:a}),l?.length&&(c.args=l)},n=(r,i,o,a,p,l,c)=>{let f=i.split(":").shift();(!r||r?.[f]||S.includes(a))&&console[a].apply(console,[...o,...c||[],`	[${l}]`])};return t.flags=e,t.get=()=>m,t.clear=()=>m.splice(0,-1),t.replay=(r,i)=>{console.group.apply(console,[...M("Logger","white","gray"),"Replay"]),m.filter(i??(o=>o)).forEach(({preamble:o,format:a,kind:p,when:l,where:c,args:f})=>{n(r,o,a,p,l,c,f)}),console.groupEnd()},t};globalThis.logf?console.warn("attempted global logf overwrite"):globalThis.logf=F();var at=globalThis.logf;var{floor:R,pow:_,random:w}=Math,ct=e=>R((1+w()*9)*_(10,e-1)),O=e=>R(w()*e),k=e=>e[O(e.length)],pt=e=>w()<e;var ft=(e,t,s)=>{e=e||2,t=t||2,s=s||"-";let n=Math.pow(10,t-1),r=Math.pow(10,t)-n,i=[];for(let o=0;o<e;o++)i.push(`${O(r-n)+n}`);return i.join(s)};var dt=(e,t)=>{let s=t;if(t){if(Array.isArray(t)){Array.isArray(e)||(e=[]);for(let r=0;r<t.length;r++){let i=t[r];e[r]!==i&&(e[r]=i)}let n=e.length-t.length;n>0&&e.splice(t.length,n)}else if(typeof t=="object"){s=e&&typeof e=="object"?e:Object.create(null);let n={};Object.keys(t).forEach(r=>{s[r]=t[r],n[r]=!0}),Object.keys(s).forEach(r=>{n[r]||delete s[r]})}}return s},yt=(e,t)=>{if(t==null)return null;if(typeof t=="object"){let s=e&&typeof e=="object"?e:Object.create(null);return Object.keys(t).forEach(n=>s[n]=t[n]),s}return t},G=(e,t)=>{if(t!==null){if(typeof t=="object"&&!Array.isArray(t)){let s=e&&typeof e=="object"?e:Object.create(null);return Object.keys(t).forEach(n=>s[n]=G(s[n],t[n])),s}return t}return e};function h(e){if(e){if(Array.isArray(e))return e.map(t=>h(t));if(typeof e=="object"){let t=Object.create(null);return Object.entries(e).forEach(([s,n])=>{t[s]=h(n)}),t}else return e}else return e}var b=(e,t)=>{let s=typeof e;if(s!==typeof t)return!1;if(s==="object"&&e&&t){let n=Object.getOwnPropertyNames(e),r=Object.getOwnPropertyNames(t);return n.length==r.length&&!n.some(i=>!b(e[i],t[i]))}return e===t},H=e=>e===void 0?null:(e&&typeof e=="object"&&Object.getOwnPropertyNames(e).forEach(s=>{let n=e[s];n===void 0?delete e[s]:H(n)}),e);var g=Object,v={create:g.create,assign:g.assign,nob(){return g.create(null)},keys(e){return e?g.keys(e):[]},values(e){return e?g.values(e):[]},entries(e){return e?g.entries(e):[]},mapBy(e,t){return v.values(e).reduce((s,n)=>(s[t(n)]=n,s),v.nob())},map(e,t){return v.entries(e).map(([s,n])=>t(s,n))}},{create:bt,assign:vt,keys:xt,values:wt,entries:Ot,nob:Dt,map:Et,mapBy:$t}=v;var K=class{map;constructor(e){this.map={},this.setRoot(e)}add(e){Object.assign(this.map,e||{})}resolve(e){let t;do e=this._resolve(t=e);while(t!==e);return e}_resolve(e){let t=e.split("/"),s=t.shift();return[this.map[s]||s,...t].join("/")}setRoot(e){e.length&&e[e.length-1]==="/"&&(e=e.slice(0,-1)),this.add({$root:e,$xenon:e})}getAbsoluteHereUrl(e,t){let s=e.url.split("/").slice(0,-(t??1)).join("/");if(globalThis?.document){let n=document.URL;n[n.length-1]!=="/"&&(n=`${n.split("/").slice(0,-1).join("/")}/`);let r=new URL(s,n).href;return r[r.length-1]==="/"&&(r=r.slice(0,-1)),r}else return s}},N="",V=globalThis.Paths=new K(N??"");V.add(globalThis.config?.paths);var u=Object,{defineProperty:J,setPrototypeOf:Ut}=u,{create:B,assign:Q,keys:Ct,values:zt,entries:St,mapBy:Ft}={create:u.create,assign:u.assign,keys(e){return e?u.keys(e):[]},values(e){return e?u.values(e):[]},entries(e){return e?u.entries(e):[]},mapBy(e,t){return e?u.values(e).reduce((s,n)=>(s[t(n)]=n,s),{}):{}}},L=globalThis.scope??globalThis,y=()=>B(null),W=e=>{let t=e;return{get:()=>t,set:s=>t=s}},D=class{pipe;impl;internal;constructor(t,s,n){this.pipe=s,this.impl=B(t),globalThis.harden?.(this.impl),J(this,"internal",W(y())),this.internal.$busy=0,this.internal.beStateful=!0,this.internal.state=y(),this.internal.clean=y()}get log(){return this.pipe?.log||log}get template(){return this.impl?.template}get config(){return{template:this.template}}set inputs(t){this.internal.inputs=t,this.invalidateInputs()}get inputs(){return this.internal.inputs}get state(){return this.internal.state}isDirty(t){let s=this.internal.clean,n=this.internal.inputs[t];return deepEqual(n,s[t])?!1:(s[t]=n,!0)}async service(t,s,n){return typeof t=="string"&&(t={kind:t,msg:s,data:n}),this.pipe?.service?.(t)}invalidateInputs(){this.internal.$propChanged=!0,this.invalidate()}invalidate(){this.internal.validator||(this.internal.validator=timeout(this.validate.bind(this),1))}async validate(){if(this.internal.validator){try{this.internal.$validateAfterBusy=this.internal.$busy,this.internal.$busy||(this.internal.beStateful||(this.internal.state=y()),this.internal.inputs=this.validateInputs(),await this.maybeUpdate())}catch(t){log.error(t)}this.internal.validator=null,this.internal.$propChanged=!1}}validateInputs(){return Q(y(),this.inputs)}implements(t){return typeof this.impl?.[t]=="function"}async maybeUpdate(){this.checkInit()||await this.doInit();let t=!1;if(this.implements("update")&&(t=!this.implements("shouldUpdate")||await this.shouldUpdate(this.inputs,this.state)),t)return this.update();this.outputData(null)}checkInit(){return this.internal.initialized}async doInit(){this.internal.initialized=!0,this.implements("initialize")&&await this.asyncMethod(this.impl.initialize)}async shouldUpdate(t,s){return!this.implements("shouldUpdate")||await this.impl.shouldUpdate(t,s)}update(){this.asyncMethod(this.impl?.update)}outputData(t){this.pipe?.output?.(t,this.maybeRender())}maybeRender(){if(this.template){let{inputs:t,state:s}=this.internal;if(!this.implements("shouldRender")||this.impl?.shouldRender?.(t,s))return this.implements("render")?this.impl.render(t,s):{...t,...s}}}async handleEvent({handler:t,data:s}){let n=this.impl?.[t];n&&(this.internal.inputs.eventlet=s,await this.asyncMethod(n.bind(this.impl),{eventlet:s}),this.internal.inputs.eventlet=null)}async asyncMethod(t,s){if(t){let{inputs:n,state:r}=this.internal,i={service:async(...a)=>this.service(...a),invalidate:()=>this.invalidate(),output:async a=>this.outputData(a),isDirty:a=>this.isDirty(a)},o=t.bind(this.impl,n,r,{...i,...s});this.outputData(await this.try(o)),!this.internal.$busy&&this.internal.$validateAfterBusy&&this.invalidate()}}async try(t){this.internal.$busy++;try{return await t()}catch(s){log.error(s)}finally{this.internal.$busy--}}};L.harden?.(globalThis);L.harden?.(D);var x=class{listeners={};getEventListeners(t){return this.listeners[t]||(this.listeners[t]=[])}fire(t,...s){let n=this.getEventListeners(t);n?.forEach&&n.forEach(r=>r(...s))}listen(t,s,n){if(!s){console.warn("Got a null listener",t);return}return this.getEventListeners(t).push(s),s._name=n||"(unnamed listener)",s}unlisten(t,s){let n=this.getEventListeners(t),r=typeof s=="string"?n.findIndex(i=>i._name===s):n.indexOf(s);r>=0?n.splice(r,1):console.warn("failed to unlisten from",t)}};var{values:X,entries:T}=Object,P={},E=logf("Decorator","plum"),$={setOpaqueData(e,t){return P[e]=t,e},getOpaqueData(e){return P[e]},maybeDecorateModel(e,t){return e&&!Array.isArray(e)&&X(e).forEach(s=>{s&&typeof s=="object"&&(s.models?(E("applying decorator(s) to list:",s),this.maybeDecorateItem(s,t)):(e?.filter||e?.decorator||e?.collateBy)&&(E("scanning for lists in sub-model:",s),this.maybeDecorateModel(s,t)))}),e},maybeDecorateItem(e,t){let s=typeof e.models=="string"?this.getOpaqueData(e.models):e.models;s&&(s=Y(s,e.decorator,t),s=Z(s,e.filter,t.impl),s=q(s,e),e.models=s)}},Y=(e,t,s)=>{t=s.impl[t]??t;let{inputs:n,state:r}=s.internal;if(t){let i=Object.freeze(h(n)),o=Object.freeze(h(r));e=e.map(a=>{a.privateData=a.privateData||{};let p=Object.freeze(h(a)),l=t(p,i,o);return a.privateData=l.privateData,{...l,...a}}),e.sort(et("sortKey")),E("decoration was performed")}return e},Z=(e,t,s)=>(t=s[t]??t,t&&e&&(e=e.filter(t)),e),q=(e,t)=>(T(t).forEach(([s,n])=>{if(n?.collateBy){let r=st(e,n.collateBy);e=nt(r,s,n.$template)}}),e),tt=(e,t)=>e<t?-1:e>t?1:0,et=e=>(t,s)=>tt(String(t[e]).toLowerCase(),String(s[e]).toLowerCase()),st=(e,t)=>{let s={};return e.forEach(n=>{let r=n[t];r&&(s[r]||(s[r]=[])).push(n)}),s},nt=(e,t,s)=>T(e).map(([n,r])=>({key:n,[t]:{models:r,$template:s},single:r.length===1,...r?.[0]}));var{entries:U,keys:rt}=Object,it=e=>logf(`Host (${e})`,k(ot)),ot=["#5a189a","#51168b","#48137b","#6b2fa4","#7b46ae","#3f116c"],C=class extends x{id;lastOutput;lastPacket;lastRenderModel;log;meta;atom;constructor(t){super(),this.log=it(t),this.id=t,this.name=t}dispose(){this.detach()}onevent(t){this.fire("eventlet",t)}installAtom(t,s){this.atom&&this.detachAtom(),t&&(this.atom=t,this.meta=s||this.meta)}get container(){return this.meta?.container||"root"}detach(){this.detachAtom()}detachAtom(){this.atom&&(this.render({$clear:!0}),this.atom=null,this.meta=null)}async service(t){if(t?.decorate)return $.maybeDecorateModel(t.model,this.atom);if(t){let s=new Promise(n=>t.resolve=r=>{delete t.resolve,n(r)});return this.fire("service",t),s}}output(t,s){t&&(this.lastOutput=t,this.fire("output",t)),this.template&&($.maybeDecorateModel(s,this.atom),this.lastRenderModel={...s},this.render(s))}render(t){let{id:s,container:n,template:r}=this,o={id:s,container:n,content:{model:t,template:r}};this.fire("render",o),this.lastPacket=o}rerender(){this.lastRenderModel&&this.render(this.lastRenderModel)}set inputs(t){if(this.atom&&t){let s=this.atom.internal.inputs??this.meta?.staticInputs??Object.create(null);this.atom.inputs=h({...s,...t}),this.fire("inputs-changed")}}dirtyCheck(t,s,n){let r=([i,o])=>n?.[i]&&!b(n[i],o)||!b(s?.[i],o);return!s||U(t).length!==this.lastInputsLength(s)||U(t).some(r)}lastInputsLength(t){return rt(t).filter(s=>!this.meta?.staticInputs?.[s]&&s!=="eventlet").length}get config(){return this.atom?.config}get template(){return this.config?.template}hasTemplate(){return!!this.template}invalidate(){this.atom?.invalidate()}handleEvent(t){return this.atom?.handleEvent(t)}};export{D as Atom,x as EventEmitter,C as Host,K as PathMapper,V as Paths,v as SafeObject,k as arand,vt as assign,bt as create,F as createLogFactory,h as deepCopy,b as deepEqual,G as deepMerge,H as deepUndefinedToNull,Ot as entries,S as importantKinds,O as irand,ct as key,xt as keys,z as logKinds,at as logf,ft as makeId,Et as map,$t as mapBy,Dt as nob,pt as prob,yt as shallowMerge,dt as shallowUpdate,wt as values};
/**
 * @license
 * Copyright 2023 NeonFlan LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
/**
 * @license
 * Copyright 2023 NeonFlan LLC
 * SPDX-License-Identifier: BSD-3-Clause
 * @module Decorator
 */
//# sourceMappingURL=atomic.min.js.map
