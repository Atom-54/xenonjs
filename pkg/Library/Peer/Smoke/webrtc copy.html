<!DOCTYPE html>

<script type="importmap">{
  "imports": {
    "libp2p/": "../../../third-party/libp2p/"
  }
}</script>

<input style="width: 400px;" placeholder="multiaddress" id="ma" value="/ip4/192.168.50.15/tcp/49416/ws/p2p/12D3KooWEmR8QcHQcX31rYGNKU4vHHZinPxd2cGAtG1m2h5agtdr"><br>
<button onclick="connect()">Connect</button>
<hr>
<h3>Connections</h3>
<div id="connections"></div>
<h3>Multiaddrs</h3>
<div id="multiaddrs"></div>

<script type="module">
import 'libp2p/index.min.js';
import 'libp2p/circuit-relay/index.min.js';
import 'libp2p/webrtc/index.min.js';
import 'libp2p/websockets/index.min.js';
import 'libp2p/mplex/index.min.js';
import 'libp2p/bootstrap/index.min.js';
import 'libp2p/chainsafe/libp2p-noise/index.min.js';
import 'libp2p/chainsafe/libp2p-yamux/index.min.js';
import 'libp2p/multiformats/multiaddr/index.min.js';
//import 'libp2p/{ circuitRelayTransport } from 'libp2p/circuit-relay'

console.log(Object.keys(globalThis.Libp2P));
console.log(Object.keys(globalThis.Libp2PWebrtc));
console.log(Object.keys(globalThis.Libp2PWebsockets));
console.log(Object.keys(globalThis.Libp2PMplex));
console.log(Object.keys(globalThis.Libp2PBootstrap));
console.log(Object.keys(globalThis.ChainsafeLibp2PNoise));
console.log(Object.keys(globalThis.ChainsafeLibp2PYamux));
console.log(Object.keys(globalThis.MultiformatsMultiaddr));

const {createLibp2p} = globalThis.Libp2P;
const {webRTC} = globalThis.Libp2PWebrtc;
const {webSockets, filters} = globalThis.Libp2PWebsockets;
const {mplex} = globalThis.Libp2PMplex;
const {bootstrap} = globalThis.Libp2PBootstrap;
const {noise} = globalThis.ChainsafeLibp2PNoise;
const {yamux} = globalThis.ChainsafeLibp2PYamux;
const {multiaddr, protocols} = globalThis.MultiformatsMultiaddr;
const {circuitRelayTransport} = globalThis.Libp2pCircuitRelay;

const WEBRTC_CODE = protocols('webrtc').code

// Known peers addresses
const bootstrapMultiaddrs = [
  '/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb',
  '/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN'
];

const node = await createLibp2p({
  addresses: {
    listen: [
      '/webrtc'
    ]
  },
  transports: [
    webSockets({
      filter: filters.all
    }),
    webRTC(),
    circuitRelayTransport({
      discoverRelays: 1,
    })
  ],
  connectionEncryption: [noise()],
  streamMuxers: [yamux(), mplex()],
  // relay: {
  //   enabled: true,
  //   autoRelay: {
  //     enabled: true,
  //     maxListeners: 2
  //   }
  // },
  connectionGater: {
    denyDialMultiaddr: () => {
      // by default we refuse to dial local addresses from the browser since they
      // are usually sent by remote peers broadcasting undialable multiaddrs but
      // here we are explicitly connecting to a local node so do not deny dialing
      // any discovered address
      return false
    }
  },
  services: {
    identify: identifyService()
  }
});

await node.start();
console.log(`Node started with id ${node.peerId.toString()}`)

node.addEventListener("self:peer:update", (event) => {
  // Update multiaddrs list
  const multiaddrs = node.getMultiaddrs()
    .map((ma) => {
      const el = document.createElement("li")
      el.textContent = ma.toString()
      return el
    })
  ;
  globalThis.multiaddrs.replaceChildren(...multiaddrs);
});

globalThis.connect = async () => {
  const ma = globalThis.ma.value;
  const relayAddr = multiaddr(ma); //'/ip4/127.0.0.1/tcp/49416/ws/p2p/12D3KooWEmR8QcHQcX31rYGNKU4vHHZinPxd2cGAtG1m2h5agtdr');
  const conn = await node.dial(relayAddr)
  console.log(`Connected to the HOP relay ${conn.remotePeer.toString()}`)
};

function updateConnList() {
  // Update connections list
  const connListEls = node
    .getConnections()
    .map((connection) => {
      if (connection.remoteAddr.protoCodes().includes(WEBRTC_CODE)) {
        sendSection.style.display = "block"
      }

      const el = document.createElement("li")
      el.textContent = connection.remoteAddr.toString()
      return el
    })
    ;
  globalThis.connections.replaceChildren(...connListEls);
};

node.addEventListener("connection:open", (event) => {
  updateConnList();
});

node.addEventListener("connection:close", (event) => {
  updateConnList();
});

// Wait for connection and relay to be bind for the example purpose
// node.addEventListener('self:peer:update', (evt) => {
//   // Updated self multiaddrs?
//   console.log(`Advertising with a relay address of ${node.getMultiaddrs()[0].toString()}`)
// })

//node.getMultiaddrs().forEach((ma) => console.log(ma.toString()))

// const ma =  multiaddr('/ip4/127.0.0.1/tcp/51975/ws/p2p/12D3KooWSDp5xvrgubiKhPPbp5SbgXRpiYB57YmoTSf5yhfMajUs')
// const stream = await node.dialProtocol(ma, ['/xen-protocol/1.0.0'])

// const message = `Hello js-libp2p-webrtc\n`
// const response = await pipe([fromString(message)], stream, async (source) => await first(source))
// const responseDecoded = toString(response.slice(0, response.length))

</script>