var A=Object.defineProperty;var j=(e,t)=>{for(var r in t)A(e,r,{get:t[r],enumerable:!0})};var a=class{listeners={};getEventListeners(t){return this.listeners[t]||(this.listeners[t]=[])}fire(t,...r){let s=this.getEventListeners(t);s?.forEach&&s.forEach(n=>n(...r))}listen(t,r,s){if(!r){console.warn("Got a null listener",t);return}return this.getEventListeners(t).push(r),r._name=s||"(unnamed listener)",r}unlisten(t,r){let s=this.getEventListeners(t),n=typeof r=="string"?s.findIndex(o=>o._name===r):s.indexOf(r);n>=0?s.splice(n,1):console.warn("failed to unlisten from",t)}};var M=(e,t)=>{let r=t;if(t){if(Array.isArray(t)){Array.isArray(e)||(e=[]);for(let n=0;n<t.length;n++){let o=t[n];e[n]!==o&&(e[n]=o)}let s=e.length-t.length;s>0&&e.splice(t.length,s)}else if(typeof t=="object"){r=e&&typeof e=="object"?e:Object.create(null);let s={};Object.keys(t).forEach(n=>{r[n]=t[n],s[n]=!0}),Object.keys(r).forEach(n=>{s[n]||delete r[n]})}}return r},P=(e,t)=>{if(t==null)return null;if(typeof t=="object"){let r=e&&typeof e=="object"?e:Object.create(null);return Object.keys(t).forEach(s=>r[s]=t[s]),r}return t},y=(e,t)=>{if(t!==null){if(typeof t=="object"&&!Array.isArray(t)){let r=e&&typeof e=="object"?e:Object.create(null);return Object.keys(t).forEach(s=>r[s]=y(r[s],t[s])),r}return t}return e};function c(e){if(e){if(Array.isArray(e))return e.map(t=>c(t));if(typeof e=="object"){let t={};return Object.entries(e).forEach(([r,s])=>{t[r]=c(s)}),t}else return e}else return e}var p=(e,t)=>{let r=typeof e;if(r!==typeof t)return!1;if(r==="object"&&e&&t){let s=Object.getOwnPropertyNames(e),n=Object.getOwnPropertyNames(t);return s.length==n.length&&!s.some(o=>!p(e[o],t[o]))}return e===t},b=e=>e===void 0?null:(e&&typeof e=="object"&&Object.getOwnPropertyNames(e).forEach(r=>{let s=e[r];s===void 0?delete e[r]:b(s)}),e);var{floor:L,pow:J,random:I}=Math;var f=e=>L(I()*e),d=e=>e[f(e.length)];var{values:R,entries:O}=Object,x={},h=logf("Decorator","plum"),u={setOpaqueData(e,t){return x[e]=t,e},getOpaqueData(e){return x[e]},maybeDecorateModel(e,t){return e&&!Array.isArray(e)&&R(e).forEach(r=>{r&&typeof r=="object"&&(r.models?(h("applying decorator(s) to list:",r),this.maybeDecorateItem(r,t)):(e?.filter||e?.decorator||e?.collateBy)&&(h("scanning for lists in sub-model:",r),this.maybeDecorateModel(r,t)))}),e},maybeDecorateItem(e,t){let r=typeof e.models=="string"?this.getOpaqueData(e.models):e.models;r&&(r=B(r,e.decorator,t),r=C(r,e.filter,t.impl),r=$(r,e),e.models=r)}},B=(e,t,r)=>{t=r.impl[t]??t;let{inputs:s,state:n}=r.internal;if(t){let o=Object.freeze(c(s)),i=Object.freeze(c(n));e=e.map(l=>{l.privateData=l.privateData||{};let w=Object.freeze(c(l)),m=t(w,o,i);return l.privateData=m.privateData,{...m,...l}}),e.sort(T("sortKey")),h("decoration was performed")}return e},C=(e,t,r)=>(t=r[t]??t,t&&e&&(e=e.filter(t)),e),$=(e,t)=>(O(t).forEach(([r,s])=>{if(s?.collateBy){let n=k(e,s.collateBy);e=_(n,r,s.$template)}}),e),T=e=>(t,r)=>U(String(t[e]).toLowerCase(),String(r[e]).toLowerCase()),U=(e,t)=>e<t?-1:e>t?1:0,k=(e,t)=>{let r={};return e.forEach(s=>{let n=s[t];n&&(r[n]||(r[n]=[])).push(s)}),r},_=(e,t,r)=>O(e).map(([s,n])=>({key:s,[t]:{models:n,$template:r},single:n.length===1,...n?.[0]}));var{entries:z,keys:S}=Object,F=e=>logf(`Host (${e})`,d(q)),q=["#5a189a","#51168b","#48137b","#6b2fa4","#7b46ae","#3f116c"],v=class extends a{id;lastInputs;lastOutput;lastPacket;lastRenderModel;log;meta;atom;constructor(t){super(),this.log=F(t),this.id=t,this.name=t}dispose(){this.detach()}onevent(t){this.fire("eventlet",t)}installAtom(t,r){this.atom&&this.detachAtom(),t&&(this.atom=t,this.meta=r||this.meta)}get container(){return this.meta?.container||"root"}detach(){this.detachAtom()}detachAtom(){this.atom&&(this.render({$clear:!0}),this.atom=null,this.meta=null)}async service(t){if(t?.decorate)return u.maybeDecorateModel(t.model,this.atom);if(t){let r=new Promise(s=>t.resolve=n=>{delete t.resolve,s(n)});return this.fire("service",t),r}}output(t,r){t&&(this.lastOutput=t,this.fire("output",t)),this.template&&(u.maybeDecorateModel(r,this.atom),this.lastRenderModel={...r},this.render(r))}rerender(){this.lastRenderModel&&this.render(this.lastRenderModel)}render(t){let{id:r,container:s,template:n}=this,i={id:r,container:s,content:{model:t,template:n}};this.fire("render",i),this.lastPacket=i}set inputs(t){if(this.atom&&t){let r=this.lastInputs??Object.create(null);this.lastInputs=this.atom.inputs=c({...r,...t})}}dirtyCheck(t,r,s){let n=([o,i])=>r?.[o]?!p(r?.[o],i):!0;return z(t).some(n)}lastInputsLength(t){return S(t).filter(r=>!this.meta?.staticInputs?.[r]&&r!=="eventlet").length}get config(){return this.atom?.config}get template(){return this.config?.template}hasTemplate(){return!!this.template}invalidate(){this.atom?.invalidate()}handleEvent(t){return this.atom?.handleEvent(t)}};var g={};j(g,{PathMapper:()=>E,Paths:()=>D,deepCopy:()=>c,deepEqual:()=>p,deepMerge:()=>y,deepUndefinedToNull:()=>b,makeId:()=>G,shallowMerge:()=>P,shallowUpdate:()=>M});var G=(e,t,r)=>{e=e||2,t=t||2,r=r||"-";let s=Math.pow(10,t-1),n=Math.pow(10,t)-s,o=[];for(let i=0;i<e;i++)o.push(`${f(n-s)+s}`);return o.join(r)};var E=class{map;constructor(e){this.map={},this.setRoot(e)}add(e){Object.assign(this.map,e||{})}resolve(e){let t;do e=this._resolve(t=e);while(t!==e);return e}_resolve(e){let t=e.split("/"),r=t.shift();return[this.map[r]||r,...t].join("/")}setRoot(e){e.length&&e[e.length-1]==="/"&&(e=e.slice(0,-1)),this.add({$root:e,$xenon:e})}getAbsoluteHereUrl(e,t){let r=e.url.split("/").slice(0,-(t??1)).join("/");if(globalThis?.document){let s=document.URL;s[s.length-1]!=="/"&&(s=`${s.split("/").slice(0,-1).join("/")}/`);let n=new URL(r,s).href;return n[n.length-1]==="/"&&(n=n.slice(0,-1)),n}else return r}},H="",D=globalThis.Paths=new E(H??"");D.add(globalThis.config?.paths);var{Paths:pt}=g;export{a as EventEmitter,v as Host,pt as Paths,g as utils};
/**
 * @license
 * Copyright 2023 NeonFlan LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
//# sourceMappingURL=xenon-atomic.min.js.map
